package com.example.nosco;

import java.io.File;
import java.io.FilenameFilter;

import org.bytedeco.javacpp.opencv_imgproc;
import org.bytedeco.javacpp.opencv_contrib.FaceRecognizer;
import org.bytedeco.javacpp.opencv_core.IplImage;
import org.bytedeco.javacpp.opencv_core.MatVector;
import static org.bytedeco.javacpp.opencv_core.*;
import static org.bytedeco.javacpp.opencv_highgui.*;


import org.opencv.core.Mat;

import android.os.Environment;

public class FaceRec {
	FaceRecognizer faceRecognizer;
	
	public FaceRec() {
		faceRecognizer = 
				org.bytedeco.javacpp.opencv_contrib.createLBPHFaceRecognizer(2,8,8,8,200);
	}
	
	public void train() {
		File path = Environment.getExternalStoragePublicDirectory(imgPath);

        FilenameFilter imgFilter = new FilenameFilter() {
            public boolean accept(File dir, String name) {
                name = name.toLowerCase();
                return name.endsWith(".jpg") || name.endsWith(".pgm") || name.endsWith(".png");
            }
        };
        
        File[] imageFiles = path.listFiles(imgFilter);
        
        MatVector images = new MatVector(imageFiles.length);
        Mat labels = new Mat((int) images.size(), 1, CvType.CV_32SC1);
        
        for (int i=0; i<imageFiles.length; ++i) {
        	Mat img = imread(imageFiles[i].getAbsolutePath(), CV_LOAD_IMAGE_GRAYSCALE);
            int label = Integer.parseInt(imageFiles[i].getName().split("\\-")[0]);
            
            images.put(i, img.data);
            
            labels.put(i, 0, label);
        }
	}
	
	public int predict(Mat face) {
		
		
		// TODO: Remove this line
		return 0;
	}
	
	public FaceRecognizer trainModel() {
		File path = Environment.getExternalStoragePublicDirectory(imgPath);

        FilenameFilter imgFilter = new FilenameFilter() {
            public boolean accept(File dir, String name) {
                name = name.toLowerCase();
                return name.endsWith(".jpg") || name.endsWith(".pgm") || name.endsWith(".png");
            }
        };
        
        File[] imageFiles = path.listFiles(imgFilter);
        
        MatVector images = new MatVector(imageFiles.length);
        Mat labels = new Mat((int) images.size(), 1, CvType.CV_32SC1);
        
        for (int i=0; i<imageFiles.length; ++i) {
        	Mat img = Highgui.imread(imageFiles[i].getAbsolutePath());
            int label = Integer.parseInt(imageFiles[i].getName().split("\\-")[0]);
            
            //images.put(i, img.data);
            
            labels.put(i, 0, label);
        }
        FaceRecognizer faceRecognizer = createFisherFaceRecognizer();
        //faceRecognizer.train
        
        return faceRecognizer;
	}
}
