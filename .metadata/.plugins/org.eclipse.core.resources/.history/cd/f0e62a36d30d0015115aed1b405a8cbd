package com.example.nosco;

import java.io.File;
import java.io.FilenameFilter;
import java.nio.IntBuffer;

import org.bytedeco.javacpp.opencv_imgproc;
import org.bytedeco.javacpp.opencv_contrib.FaceRecognizer;
import org.bytedeco.javacpp.opencv_core.IplImage;
import org.bytedeco.javacpp.opencv_core.MatVector;

import static org.bytedeco.javacpp.opencv_core.*;
import static org.bytedeco.javacpp.opencv_highgui.*;
import android.os.Environment;

public class FaceRec {
	private FaceRecognizer faceRecognizer;
	private static final String imgPath = Environment.DIRECTORY_PICTURES;
	
	public FaceRec() {
		faceRecognizer = 
				org.bytedeco.javacpp.opencv_contrib.createLBPHFaceRecognizer(2,8,8,8,200);
	}
	
	public void train() {
		File path = Environment.getExternalStoragePublicDirectory(imgPath);

        FilenameFilter imgFilter = new FilenameFilter() {
            public boolean accept(File dir, String name) {
                name = name.toLowerCase();
                return name.endsWith(".jpg") || name.endsWith(".pgm") || name.endsWith(".png");
            }
        };
        
        File[] imageFiles = path.listFiles(imgFilter);
        
        MatVector images = new MatVector(imageFiles.length);
        Mat labels = new Mat((int) images.size(), 1, CV_32SC1);
        IntBuffer labelsBuff = labels.getIntBuffer();
        
        for (int i=0; i<imageFiles.length; ++i) {
        	Mat img = imread(imageFiles[i].getAbsolutePath(), CV_LOAD_IMAGE_GRAYSCALE);
            int label = Integer.parseInt(imageFiles[i].getName().split("\\-")[0]);
            
            images.put(i, img);
            
            labelsBuff.put(i, label);
        }
        faceRecognizer.train(images, labels);
	}
	
	public int predict(org.opencv.core.Mat face) {
		
		
		// TODO: Remove this line
		return 0;
	}
	
	
	  private IplImage MatToIplImage(Mat m,int width,int heigth)
	  {
		 
		  
		   Bitmap bmp=Bitmap.createBitmap(m.width(), m.height(), Bitmap.Config.ARGB_8888);
		  
		   
		   Utils.matToBitmap(m, bmp);
		   return BitmapToIplImage(bmp,width, heigth);
			
	  }
}
